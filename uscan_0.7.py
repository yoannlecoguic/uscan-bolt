import socket
import os
import threading
import time
import re
import string
from datetime import datetime

global active_threads
active_threads = 0

continu = True

def check_port(ip, port, time_out):
        try:
                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                s.settimeout(time_out)     
                s.connect((ip, port))
                
                print(str(ip)+": port "+str(port)+" open in TCP ("+socket.gethostname()+")\n")
        except:
                pass
                
def check_all_port(ip, port_first, port_last, time_out):
        print("--------------------------------------------")
        print("Scan en cours ...")
        t1 = datetime.now()
        t1.strftime("%M:%S.%f")
        
        for i in range(port_first, port_last+1):
                if active_threads <=865:
                        thread = port_map(ip, i, time_out)
                        thread.start()
                else:
                        time.sleep(time_out)
                        thread = port_map(ip, i, time_out)
                        thread.start()
        thread.join()
        t2 = datetime.now()
        t2.strftime("%M:%S.%f")
        total = t2 - t1
        print("--------------------------------------------")
        print(str(i)+" ports scannes en ",total,"\n")    
                
class port_map(threading.Thread):
        def __init__(self, ip, port, type_co):
                threading.Thread.__init__(self)
                self.ip = ip
                self.port = port
                self.type_co = type_co
                global active_threads
                active_threads += 1
        
        def run(self):
                check_port(self.ip,self.port,self.type_co)
                self.stop()

        def stop(self):
                global active_threads
                active_threads -= 1

#----------------------------------UI---------------------------------------#
print(""";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  .;:::::;;;:::::;;;:::;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:  .::::::::;:;::;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:  .:::::::::::;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;:;;;;;;;;;;:  .::::::::::::::;;;;;;;;;;;;;;;;;,;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:  .:::::::::::::::;:;;;;;;;;;;:'#:;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:  .;;;;:;::::::::::;::;;;;;:'++;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  .;:::::::::::::::;;:;;:;++##';;;;;
;;;;';;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  `;:::::::::::::::;;;:++#',+:;;;;;
;;;;;';;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  `;::::::::::;;;;,;++##+';+;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  `;:::::::::;,:+###@'#@'::;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  `;:::::::;'+++##;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;`  ;::;''''++##@:;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;:#';;';;;;;;;;;;;;;;;;;;;;;.  '+++++####+:::;;;;;;;;;;;;;
;;;;;;;;:;;;;:;;;##;'+''::::::::::::::;;;;;;;.''#######@,::::;;;;;;;;;;;;;
;;;;;:;;:;;;;;;:##+'+;'++:::::::::::::::;,:;;'';;'+####:::::;;:;;;;;;;;;;;
;;;;;;;;;;;;;;;;###+#''#+;'+##'::;'''''';;''''+''++#@:::::::::;;;;;;;;;;;;
;;;;;;;:;;;:;;;;@####+#++'+##++;''''';'''++#####@#@,;:::::::::::;;;;;;;;;;
;;;;;;;::;:::;;;'@@@#@+##+#+##,++'';'+++#####@#:;:`  :::::::::;;;;;;;;;;:.
;;;;;::;::::::;;;#@@##++#+'@#@+'+++++#####@#::;;;;;,  ,:::::::::::;:,`   `
;;;;;;;;;;;;;;:;;:@@@@###+###;+:##++##@@':;;;;;;;;;;:  .:::::;;:.   `,;;;;
;;;;;;;;;;;;;;;;;;:@@@@@#++#';,;;#++#@+;;;::;:::;;;;;;  `;:,`   `,;;;;;;;;
;;;;;;;;;;;;;;;;:;;'@@@####:,'':;'++#+#':;;;;;;:;;;;;;;`    .,...,::;;;;;;
;;;;;;;;;;;;;;;;;:;;@@@@@@;++'+;;::+++'+;;;;;;;;;;;;;:;;,  ,:::;:::::;;;;;
;;;;;;;;;;;;;;;::;#@@@@##.';:,:;;::::,,+';;;;;;;;;;;;;:;;;  `;::::::::;;;;
;;;;;;;;;;;;;;;:'+++;++;@,':::,:@::::,,:+,;;;:;;;;;:;;;:;;;`  ;:::;:;:;;;;
;;;;;;;;;;;;;;;+'+##+''++,:;:;#:+@:::,,,++:;;;;:;;::;;;;:;;;.  :::;::;:;;;
;;;;;;;;;;;;:+';;;''''##'+;;'@#@,,;:;,::,+;;;;;;;;;;::;;;:;;;;  .;;;;;:;;;
;;;;;;;;:::::;;'''++'#;+++;@#+::,,::,,,,;'+:;;;;;;;;;;;:::;:;;;   ;;;;;;;;
;;;;;;:''++++##@###+#+@+;#@###';:::,;,::.;'+;;;;;;;;;;;;;;;;;;;;,  ,;;;;;;
;;;;;;+++#####@+#@;;@#@+'#'++':,;;;;:`:,,,,;'::::;;:::;:::::::;;;;  `;;;;;
;;;;;''+++####@@':;;;@+@+#'';;;'+':# `,,:,,.'::::;;;:::::::;;:;:;;;`  ;;;;
;;;;;@@###@@@#:;;::;;+++#+++';,#;+,`@ `:;,,,,+;;::;;:::;;:::;;;;;;;;:  ,;;
;;;;;@@@@@@,;;:::;;::;++++++'#'':`.``@` :,:;,,';;:::;:;:;;:::;;;;;;;;;  `;
;;;;;:''##:;;;;;;;;;;:'++@+++@;,::@#   ',:::+::::;:;:::;:;;;;:;:;;;;;;;,  
;;;;;;;;;;;;;;;;;;;;;;+''#+#+`+@'```+`+;:''+@';+;;;:::::;:;:;;;;;;;;;;;;; 
;;;;;;;;;;;;;;;;;;;;;;:'+'#+++`##@@ ';::;:,,'#;;+;;:::;:;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;+;;++++:'@`;:':;;;;''+''';::;:;;;:;;;;;;;;;;;;;;;;'
;;;;;;;;;;;;;;;;:;;;;;;';''####;+#',,,:::::,;+;';':;;;;;;:;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;:+;++#+++#+'';;',,+,:',:;'#+:;;;::;;:;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;'';+++@+++++';+''';:::+'+++::;:;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;';;++##++++#+#;;+#+@##+'+++::;;;:;:;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;:;;'###;;;''##@###++++'++#::;:;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;'###++####+##';''++''+# ::;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;'##++##+++#+++++####+++',;:;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;,+##+++++'#++++++++###++++@;;;:;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;:;#;+##+++++++++#########++'+#;;;;;;;';;;;';;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;'+''++++++####@@@@@#######+++++;;;;;;;';;;;;;'';
;;;;;;;;;;;;;;;;;;;;;;;;;;@#++++++++####@@@#@@@@@####++++;;;;;;;;;;;;;';;'
;;;;;;;;;;;;;;;;;;;;;;;;;'+++++++++#####@####@@@@@####++;;;;;;;;;;;;';;';'
;;;;;;;;;;;;;;;;;;;;;;;;::''+++++######@######@@@@@@@#+;;'';;;;;;''';;';;;
;;;;;;;;;;;;;;;;;;;;;;;:;''+;+++#####@#########@@@@@###+''';;;;;;;;;;;;;''
;;;;;;;;;;;;;;;;;;;;;;;''''''++#####@###########@@@#####+''';;;;;;;;;;;;;;
+';;;';+;;;;;;;;;;;;;;;''';'++++##@@##+###########@@@@##+++';;;;;;;;;;;;;;""")
print("--------------------------------------------")
print("U-SCAN BOLT: THE WOLRD'S FASTEST PORT MAPPER")
print("--------------------------------------------")

    
while continu == True:
    print("\n------------------IP SCAN-------------------")
    print("--------------------------------------------")
    print("Veuillez entrer l'IP à scanner")
    the_input = input("Votre ip : ")
    reg_ip = re.search(r'^(([1-9]?\d|1\d\d|2[0-5][0-5]|2[0-4]\d)\.){3}([1-9]?\d|1\d\d|2[0-5][0-5]|2[0-4]\d)$', the_input)
    if reg_ip:
            ip = reg_ip.group(0)

            print("--------------------------------------------")
            print("Veuillez entrer le port de depart :")
            the_input = input("Votre port de depart :")
            reg_port_first= re.search(r'[0-9]+', the_input)
                
            if reg_port_first:
                    port_first = int(reg_port_first.group(0))
                    
                    print("--------------------------------------------")
                    print("Veuillez entrer le port d'arrivé :")
                    the_input = input("Votre port d'arrive :")
                    reg_port_last = re.search('[0-9]+',the_input)
                        
                    if reg_port_last:
                            port_last = int(reg_port_last.group(0))
                            
                            if port_first < port_last:
                                    print("--------------------------------------------")
                                    the_input = input("Le temps du time out de la requete ? ")
                                    reg_time_out = re.search(r'([0-9]+.[0-9]+)|[0-9]+',the_input)
                                    
                                    if reg_time_out:
                                            time_out = float(reg_time_out.group(0))
                                            check_all_port(ip,port_first,port_last,time_out)
                                            input("Appuyez sur une touche pour continuer ...")
                                    else:
                                            print("--------------------------------------------")
                                            print("Veuillez entrer une chiffre.")
                                            input("Appuyez sur une touche pour continuer ...")
                            else:
                                print("--------------------------------------------")
                                print("Le port de depart inferieur à celui d'arrivee")
                                input("Appuyez sur une touche pour continuer ...")
                    else:
                        print("--------------------------------------------")
                        print("Mauvais port d'arrive.")
                        input("Appuyez sur une touche pour continuer ...")
            else:
                print("--------------------------------------------")
                print("Mauvais port de depart.")
                input("Appuyez sur une touche pour continuer ...")
    else:
        print("--------------------------------------------")
        print("Veuillez entrer une ip correcte.")
        input("Appuyez sur une touche pour continuer ...")
